<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />

    <title>TensorFlow</title>

    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <link rel="stylesheet" href="./dist/reveal.css" />
    <link rel="stylesheet" href="./dist/theme/black.css" id="theme" />
    <link rel="stylesheet" href="./plugin/highlight/monokai.css" />
  </head>

  <body>
    <div class="reveal deck1">
      <div class="slides">
        <section>
          <h1>TensorFlow</h1>
          <p>前端判断是否为手写作文</p>
        </section>
        <section>
          <iframe
            style="width: 100%; height: 100vh; background-color: white"
            src="/web-handwritten/index.html"
            frameborder="0"
          ></iframe>
        </section>
        <section>
          <ul style="line-height: 2">
            <li>TensorFlow.js 介绍</li>
            <li>为什么要在客户端做机器学习？</li>
            <li>基础知识</li>
            <li>准备数据</li>
            <li>训练模型</li>
            <li>验证模型</li>
            <li>使用模型</li>
          </ul>
        </section>
        <section>
          <h2>TensorFlow.js</h2>
          <p>直接在浏览器和 Node.js 进行机器学习。</p>
          <img src="./images/tfjs.webp" alt="" />
        </section>
        <section>
          <h2>为什么要在客户端做机器学习？</h2>
          <ul style="display: block">
            <li>节省服务器资源</li>
            <li>可以离线使用</li>
            <li>延迟低</li>
            <li>隐私性好</li>
          </ul>
        </section>
        <section>
          <section>
            <h2>基础知识</h2>
          </section>
          <section>
            <h3>人工智能</h3>
          </section>
          <section>
            <h3>张量（Tensor）</h3>
          </section>
          <section>
            <h3>机器学习一般流程</h3>
          </section>
        </section>
        <section>
          <section>
            <h2>准备数据</h2>
          </section>
          <section>
            <h3>下载数据</h3>
            <img src="./images/data1.webp" alt="" />
          </section>
          <section>
            <h3>手动分类</h3>
            <img style="width: 50%" src="./images/data2.webp" alt="" />
          </section>
        </section>
        <section>
          <section>
            <h2>训练模型</h2>
          </section>
          <section>
            <h3>划分训练集和验证集</h3>
            <table>
              <tr>
                <td></td>
                <td>手写</td>
                <td>非手写</td>
              </tr>
              <tr>
                <td>训练集</td>
                <td>196</td>
                <td>132</td>
              </tr>
              <tr>
                <td>验证集</td>
                <td>49</td>
                <td>33</td>
              </tr>
            </table>
          </section>
          <section>
            <h3>划分训练集和验证集</h3>
            <pre data-id="code-animation">
              <code class="hljs python" data-trim data-line-numbers>
              train_ds = tf.keras.utils.image_dataset_from_directory(
                  data_dir,
                  validation_split=0.2,
                  subset="training",
                  seed=123,
                  image_size=(img_height, img_width),
                  batch_size=batch_size)
              
              val_ds = tf.keras.utils.image_dataset_from_directory(
                  data_dir,
                  validation_split=0.2,
                  subset="validation",
                  seed=123,
                  image_size=(img_height, img_width),
                  batch_size=batch_size)
              </code>
            </pre>
          </section>
          <section>
            <h3>创建模型</h3>
            <pre data-id="code-animation">
              <code class="hljs python" data-trim data-line-numbers>
              data_augmentation = tf.keras.Sequential(
                  [
                      tf.keras.layers.RandomFlip("horizontal",
                                                input_shape=(img_height,
                                                              img_width,
                                                              3)),
                      tf.keras.layers.RandomRotation(0.1),
                      tf.keras.layers.RandomZoom(0.1),
                  ]
              )

              model = tf.keras.Sequential([
                  data_augmentation,
                  tf.keras.layers.Rescaling(1./255),
                  tf.keras.layers.Conv2D(16, 3, activation='relu'),
                  tf.keras.layers.MaxPooling2D(),
                  tf.keras.layers.Conv2D(32, 3, activation='relu'),
                  tf.keras.layers.MaxPooling2D(),
                  tf.keras.layers.Conv2D(64, 3, activation='relu'),
                  tf.keras.layers.MaxPooling2D(),
                  tf.keras.layers.Dropout(0.2),
                  tf.keras.layers.Flatten(),
                  tf.keras.layers.Dense(128, activation='relu'),
                  tf.keras.layers.Dense(num_classes)
              ])
              
              model.compile(
                  optimizer='adam',
                  loss=tf.keras.losses.SparseCategoricalCrossentropy(from_logits=True),
                  metrics=['accuracy'])
              </code>
            </pre>
          </section>
          <section>
            <h3>跑数据</h3>
            <pre data-id="code-animation">
              <code class="hljs python" data-trim data-line-numbers>
              epochs = 30 
              history = model.fit(
                  train_ds,
                  validation_data=val_ds,
                  epochs=epochs
              )
              </code>
            </pre>
          </section>
          <section>
            <h3>不太准</h3>
            <div style="display: flex; gap: 10px">
              <img style="width: 50%" src="./images/train1-res1.webp" alt="" />
              <img style="width: 50%" src="./images/train1-res2.webp" alt="" />
            </div>
          </section>
          <section>
            <h3>再次准备数据</h3>
            <img src="./images/train2-prepare.webp" alt="" />
          </section>
          <section>
            <h3>自动分类</h3>
            <pre data-id="code-animation">
              <code class="hljs python" data-trim data-line-numbers>
              for file_path in data2_dirs:
                  # ...
                  img = tf.keras.utils.load_img(
                      full_file_path, target_size=(img_height, img_width)
                  )
                  img_array = tf.keras.utils.img_to_array(img)
                  img_array = tf.expand_dims(img_array, 0)  # Create a batch
              
                  predictions = model(img_array)
                  classname = class_names[np.argmax(predictions)]
                  shutil.move(full_file_path, os.path.join(data2_dir, classname, file_path))
              </code>
            </pre>
            <small> 因为准确率太低，目前自动分类的结果基本没帮助 </small>
          </section>
          <section>
            <h3>再次训练</h3>
            <table>
              <tr>
                <td></td>
                <td>手写</td>
                <td>非手写</td>
              </tr>
              <tr>
                <td>训练集</td>
                <td>230+</td>
                <td>360+</td>
              </tr>
              <tr>
                <td>验证集</td>
                <td>60+</td>
                <td>100+</td>
              </tr>
              <tr>
                <td>测试集</td>
                <td>30+</td>
                <td>50+</td>
              </tr>
              <tr>
                <td>总计</td>
                <td>342</td>
                <td>520</td>
              </tr>
            </table>
            <p>
              <small>
                结果：test loss, test acc: [1.1063129901885986,
                0.8645833134651184]
              </small>
            </p>
          </section>
          <section>
            <h3>使用刚才的模型继续自动分类</h3>
            <img src="./images/train3-prepare.webp" alt="" />
          </section>
          <section>
            <h3>再次训练</h3>
            <table>
              <tr>
                <td></td>
                <td>手写</td>
                <td>非手写</td>
              </tr>
              <tr>
                <td>训练集</td>
                <td>360+</td>
                <td>1030+</td>
              </tr>
              <tr>
                <td>验证集</td>
                <td>100+</td>
                <td>290+</td>
              </tr>
              <tr>
                <td>测试集</td>
                <td>50+</td>
                <td>140+</td>
              </tr>
              <tr>
                <td>总计</td>
                <td>528</td>
                <td>1478</td>
              </tr>
            </table>
            <p>
              <small>
                结果：test loss, test acc: [0.25132402777671814, 0.9453125]
              </small>
            </p>
          </section>
        </section>
        <section>
          <section>
            <h2>验证模型</h2>
          </section>
        </section>
        <section>
          <section>
            <h2>使用模型</h2>
          </section>
          <section>
            <h3>Python 中使用</h3>
            <pre data-id="code-animation">
              <code class="hljs python" data-trim data-line-numbers>
              model = tf.saved_model.load(model_dir)
              # 这里不用 model.predict(img_array)
              predictions = model(img_array)
              </code>
            </pre>
          </section>
          <section>
            <h3>转为 Web 可用的模型</h3>
            <pre data-id="code-animation">
              <code class="hljs bash" data-trim data-line-numbers>
              tensorflowjs_converter \
                --input_format=tf_saved_model \
                model \
                web_model
              </code>
            </pre>
          </section>
          <section>
            <h3>JavaScript 中使用</h3>
            <pre data-id="code-animation">
              <code class="hljs js" data-trim data-line-numbers>
              const model = await tf.loadGraphModel(HANDWRITTEN_MODEL_PATH);

              const img = tf.cast(tf.browser.fromPixels(imgElement), "float32");
              const batched = img.reshape([1, IMAGE_SIZE, IMAGE_SIZE, 3]);

              const predictions = model.predict(batched);
              </code>
            </pre>
          </section>
        </section>
        <section>
          <h1>感谢大家收看</h1>
        </section>

        <section>
          <img src="./images/tf1.webp" alt="" />
          <p>80% TensorFlow.js 使用，20% 人工智能</p>
          <p>机器学习是人工智能的子集</p>
          <p>机器学习是运用统计分析创建模型</p>
          <p>TensorFlow.js 训练、检测、*使用*模型</p>
        </section>
        <section>
          <h2>VS Code 自带的增删改查</h2>
        </section>
        <section>
          <p>
            Code > Preferences > Configure User Snippets
            打开代码片段文件，通过编辑如下 JSON 文件<span class="zyb-highlight"
              >创建</span
            >、<span class="zyb-highlight">修改</span>和<span
              class="zyb-highlight"
              >删除</span
            >，工作区输入代码片段的前缀<span class="zyb-highlight">查询</span
            >并使用。
          </p>
          <pre data-id="code-animation">
            <code class="hljs" data-trim data-line-numbers>
            {
              "post": {
                "prefix": "post",
                "description": "post",
                "scope": "javascript",
                "body": [
                  "axios",
                  "  .post(\"/user\", {",
                  "    firstName: \"Fred\",",
                  "    lastName: \"Flintstone\",",
                  "  })",
                  "  .then(function (response) {",
                  "    console.log(response);",
                  "  })",
                  "  .catch(function (error) {",
                  "    console.log(error);",
                  "  });",
                  ""
                ]
              }
            }
						</code>
          </pre>
        </section>
        <section>
          <h2>
            <a
              href="https://marketplace.visualstudio.com/items?itemName=zjffun.snippetsmanager"
              >拓展程序</a
            >的增删改查
          </h2>
        </section>
        <section>
          <p>选中一段代码<span class="zyb-highlight">创建</span>代码片段</p>
          <img
            width="500px"
            src="./images/snippetsmanager-create1.webp"
            alt=""
          />
        </section>
        <section>
          <p>点击按钮<span class="zyb-highlight">删除</span>代码片段</p>
          <img src="./images/snippetsmanager-delete.webp" alt="" />
        </section>
        <section>
          <section>
            <p>
              在表单或编辑器中<span class="zyb-highlight">修改</span
              >代码片段，工作区输入代码片段的前缀<span class="zyb-highlight"
                >查询</span
              >并使用。
            </p>
            <img src="./images/snippetsmanager-edit.webp" alt="" />
          </section>
          <section>
            <p>
              在表单或编辑器中<span class="zyb-highlight">修改</span
              >代码片段，工作区输入代码片段的前缀<span class="zyb-highlight"
                >查询</span
              >并使用。
            </p>
            <img src="./images/snippetsmanager-edit-body.webp" alt="" />
          </section>
        </section>
        <section>
          <h2>代码片段高级用法</h2>
          <ul>
            <li>代码片段范围</li>
            <li>代码片段语法</li>
            <li>代码片段配合快捷键</li>
          </ul>
        </section>
        <section>
          <h3>代码片段范围</h3>
          <ul>
            <li>
              语言范围：通过 scope
              或用户代码片段的文件名可以指定代码片段在哪些语言下可用。
            </li>
            <li>
              使用范围：工作区的代码片段只能用于该工作区，用户和拓展程序提供的代码片段可以作用于全局。
            </li>
          </ul>
        </section>
        <section>
          <section>
            <h3>代码片段语法</h3>
          </section>
          <section>
            <p>制表位、占位符和选项</p>
            <pre data-id="code-animation">
              <code class="hljs language-text" data-trim data-line-numbers>
              for (${1|let,var|} i = 0; i < ${2:array}.length; i++) {
                const item = $2[i];
              }
              $0
              </code>
            </pre>
          </section>
          <section>
            <p>变量</p>
            <pre data-id="code-animation">
              <code class="hljs language-text" data-trim data-line-numbers>
              TM_SELECTED_TEXT: ${TM_SELECTED_TEXT}
              TM_CURRENT_LINE: ${TM_CURRENT_LINE}
              TM_CURRENT_WORD: ${TM_CURRENT_WORD}
              TM_LINE_INDEX: ${TM_LINE_INDEX}
              TM_LINE_NUMBER: ${TM_LINE_NUMBER}
              TM_FILENAME: ${TM_FILENAME}
              TM_FILENAME_BASE: ${TM_FILENAME_BASE}
              TM_DIRECTORY: ${TM_DIRECTORY}
              TM_FILEPATH: ${TM_FILEPATH}
              RELATIVE_FILEPATH: ${RELATIVE_FILEPATH}
              CLIPBOARD: \${CLIPBOARD}
              WORKSPACE_NAME: ${WORKSPACE_NAME}
              WORKSPACE_FOLDER: ${WORKSPACE_FOLDER}
              CURSOR_INDEX: ${CURSOR_INDEX}
              CURSOR_NUMBER: ${CURSOR_NUMBER}
              
              CURRENT_YEAR: ${CURRENT_YEAR}
              CURRENT_YEAR_SHORT: ${CURRENT_YEAR_SHORT}
              CURRENT_MONTH: ${CURRENT_MONTH}
              CURRENT_MONTH_NAME: ${CURRENT_MONTH_NAME}
              CURRENT_MONTH_NAME_SHORT: ${CURRENT_MONTH_NAME_SHORT}
              CURRENT_DATE: ${CURRENT_DATE}
              CURRENT_DAY_NAME: ${CURRENT_DAY_NAME}
              CURRENT_DAY_NAME_SHORT: ${CURRENT_DAY_NAME_SHORT}
              CURRENT_HOUR: ${CURRENT_HOUR}
              CURRENT_MINUTE: ${CURRENT_MINUTE}
              CURRENT_SECOND: ${CURRENT_SECOND}
              CURRENT_SECONDS_UNIX: ${CURRENT_SECONDS_UNIX}
              
              RANDOM: ${RANDOM}
              RANDOM_HEX: ${RANDOM_HEX}
              UUID: ${UUID}
              
              BLOCK_COMMENT_START: ${BLOCK_COMMENT_START}
              BLOCK_COMMENT_END: ${BLOCK_COMMENT_END}
              LINE_COMMENT: ${LINE_COMMENT}
              </code>
            </pre>
          </section>
          <section>
            <h3>实战</h3>
          </section>
          <section>
            <p>打印剪贴板</p>
            <pre data-id="code-animation">
              <code class="hljs language-text" data-trim data-line-numbers>
              console.log('${CLIPBOARD}: ', ${CLIPBOARD});
              </code>
            </pre>
          </section>
          <section>
            <p>剪贴板 require 转 import</p>
            <pre data-id="code-animation">
              <code class="hljs language-text" data-trim data-line-numbers>
              ${CLIPBOARD/.*? +(.*?) += +require\((.*?)\)/import $1 from $2/g}
  
              const path = require('path');
              </code>
            </pre>
          </section>
        </section>
        <section>
          <section>
            <h3>代码片段配合快捷键</h3>
          </section>
          <section>
            <p>如何方便地打印 getInfo</p>
            <pre data-id="code-animation">
              <code class="hljs language-js" data-trim data-line-numbers>
              async function getInfo(arg) {
                await new Promise((res) => setTimeout(res, 500));
                return `getInfo ${arg}`;
              }
              
              async function main() {
                return getInfo(`test`);
              }
              
              main();
              </code>
            </pre>
          </section>
          <section>
            <p>创建代码片段</p>
            <pre data-id="code-animation">
              <code class="hljs language-text" data-trim data-line-numbers>
              /* TODO: revert */ (() => {
                const TM_SELECTED_TEXT_DATA = ${TM_SELECTED_TEXT};
                if (TM_SELECTED_TEXT_DATA.then) {
                  TM_SELECTED_TEXT_DATA.then((data) => {
                    console.log(`${TM_SELECTED_TEXT/`/\`/g}:Promise:${TM_FILENAME}:${TM_LINE_NUMBER}: `, data);
                  });
                  return TM_SELECTED_TEXT_DATA;
                }
                console.log(`${TM_SELECTED_TEXT/`/\`/g}:${TM_FILENAME}:${TM_LINE_NUMBER}: `, TM_SELECTED_TEXT_DATA);
                return TM_SELECTED_TEXT_DATA;
              })(); /* TM_SELECTED_TEXT: getInfo(`test`) */
              </code>
            </pre>
          </section>
          <section>
            <p>绑定快捷键</p>
            <pre data-id="code-animation">
              <code class="hljs language-json" data-trim data-line-numbers>
              {
                "key": "cmd+l cmd+g",
                "command": "editor.action.insertSnippet",
                "when": "editorTextFocus",
                "args": {
                  "name": "clg-selected"
                }
              },
              </code>
            </pre>
          </section>
        </section>
        <section>
          <h2>优雅地修改代码片段文件</h2>
        </section>
        <section>
          <section>
            <h3>问题</h3>
          </section>
          <section>
            <p>JS Object 的特性 & JSON.stringify 缩进丢失</p>
            <pre data-id="code-animation">
            <code class="hljs language-js" data-trim data-line-numbers>
            let json = `{
              "1": {
                "prefix": "1"
              },
              "0": {
                "prefix": "0"
              }
            }`;

            const snippets = JSON.parse(json);
            json = JSON.stringify(snippets);

            console.log(json);
            // {"0":{"prefix":"0"},"1":{"prefix":"1"}}
						</code>
          </pre>
          </section>
          <section>
            <p>带注释的 JSON</p>
            <pre data-id="code-animation">
            <code class="hljs language-json" data-trim data-line-numbers>
            {
              // 文档相关
              "doc": {
                "prefix": "doc",
                "description": "doc",
                "scope": "markdown",
                "body": [
                  "### 1、产品文档",
                  "",
                  "### 2、相关人员",
                  "",
                  "### 3、代码仓库、线上地址",
                  "",
                  "### 4、部署方式",
                  "",
                  "### 5、注意事项",
                  "",
                  "### 6、TODO"
                ]
              }
            }
            </code>
          </pre>
          </section>
        </section>
        <section>
          <section>
            <h3>解决</h3>
          </section>
          <section>
            <p>
              使用
              <a href="https://www.npmjs.com/package/jsonc-parser">
                jsonc-parser
              </a>
            </p>
            <ul>
              <li>将 JSON 的对象转为 JS 的 Map</li>
              <li>修改指定的 JSON 元素</li>
            </ul>
          </section>
          <section>
            <p>
              <a
                href="https://github.com/zjffun/vscode-snippets-manager/blob/main/src/CodeSnippetsService.ts#L53-L89"
              >
                将 JSON 的对象转为 JS 的 Map
              </a>
            </p>
            <pre data-id="code-animation">
            <code class="hljs language-js" data-trim data-line-numbers>
            const visitor = {
              onObjectBegin() {
                // 创建 map 并入栈
              },
              onObjectProperty() {
                // 保存属性名
              },
              onObjectEnd() {
                // 出栈
              },
              onArrayBegin() {
                // 创建 array 并入栈
              },
              onArrayEnd() {
                // 出栈
              },
              onLiteralValue() {
                // 根据属性名为栈顶元素设置属性
              },
            };
            
            visit(this.textDocument.getText(), visitor);
          </code>
        </pre>
          </section>
          <section>
            <p>
              修改指定的 JSON 元素
              <a
                href="https://github.com/zjffun/vscode-snippets-manager/blob/main/src/vscode/src/vs/base/common/jsonEdit.ts#L14-L120"
              >
                vs/base/common/jsonEdit.ts
              </a>
            </p>

            <div style="margin: 0 -100px -70px">
              <pre data-id="code-animation">
              <code class="hljs language-js" data-trim data-line-numbers>
              let json = `{
                "1": {
                    // 这里的缩进不一样
                    "prefix": "1"
                },
                "0": {
                  "prefix": "0"
                }
              }`;
  
              const [edit] = setProperty(json, ["0", "body"], "test body", {});
              json = applyEdit(json, edit);
  
              console.log(json);
              /*
              {
                "1": {
                    // 这里的缩进不一样
                    "prefix": "1"
                },
                "0": {
                  "prefix": "0",
                  "body": "test body"
                }
              }
              */
              </code>
            </pre>
            </div>
          </section>
        </section>
      </div>
    </div>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
      }
      .reveal {
        width: 100%;
        height: 100vh;
        --r-heading-text-transform: none;
      }
      .zyb-highlight {
        color: rgba(237, 100, 166, 1);
      }
    </style>

    <script src="./dist/reveal.js"></script>
    <script src="./plugin/highlight/highlight.js"></script>
    <script src="./plugin/markdown/markdown.js"></script>
    <script src="./plugin/math/math.js"></script>
    <script>
      let deck1 = new Reveal(document.querySelector(".deck1"), {
        hash: true,
        embedded: true,
        progress: false,
        keyboardCondition: "focused",
        plugins: [RevealHighlight],
      });
      deck1.initialize();
    </script>
  </body>
</html>
